source("Functions.r")
?new_handle
??new_handle
Handle_Generator <- function(token) {
if (missing(token) || !nzchar(token)) stop("token is required")
h <- curl::new_handle()
curl::handle_setheaders(
h,
"Authorization" = paste("Bearer", token)
)
h
}
Check_Credentials <- function(Handle = ""){
resp <- curl::curl_fetch_memory(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/sites",
handle = Handle
)
status = resp$status_code
if(status %in% c(200, 201, 202, 204)){
return(paste0("Success: ",status))
}
else if(status %in% c(400, 401,403, 404, 408, 409, 410, 422, 429)){
return(paste0("There is something wrong with the request or your permission: ",status))
}
else if(status %in% c(500,502,503,504)){
return(paste0("There is a server-side error.  Retry or report to AquaWatch: ",status))
}
else{
return(paste0("Unknown ID code: ", status))
}
}
##function to get sites for token
AW_Get <- function(path, query = NULL) {
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(
paste(names(query), query, sep = "="),
collapse = "&"
)
url <- paste0(url, "?", qs)
}
h <- curl::new_handle()
handle_setheaders(
h,
"Authorization" = paste("Bearer", Sys.getenv("AQUAWATCH_API_TOKEN"))
)
resp <- curl::curl_fetch_memory(url, handle = h)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
#Wrapper
AW_Sites <- function() {
AW_Get("sites")
}
AW_Samples <- function(
device_id,
limit = NULL,
time_min = NULL,   # POSIXct, Date, or ISO string
time_max = NULL,   # POSIXct, Date, or ISO string
order = "desc",
timezone = "etc/GMT-12"
) {
as_iso <- function(x) {
if (is.null(x)) return(NULL)
if (inherits(x, "POSIXt")) return(format(as.POSIXct(x, tz = timezone), "%Y-%m-%dT%H:%M:%S"))
if (inherits(x, "Date"))   return(format(x, "%Y-%m-%d"))
as.character(x)  # assume already ISO string
}
q <- list(
limit  = limit,
after  = as_iso(time_min),
before = as_iso(time_max),
order  = order
)
q <- q[!vapply(q, is.null, logical(1))]
AW_Get(paste0(device_id, "/samples"), q)
}
Handle_Generator("CE7Otvb9XShYRfe7xoxT")
h <- Handle_Generator(token = "CE7Otvb9XShYRfe7xoxT")
Check_Credentials(Handle = h)
Sys.getenv("AQUAWATCH_API_TOKEN")
sites <- AW_Sites()
##function to get sites for token
AW_Get <- function(path, query = NULL) {
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(
paste(names(query), query, sep = "="),
collapse = "&"
)
url <- paste0(url, "?", qs)
}
h <- curl::new_handle()
curl::handle_setheaders(
h,
"Authorization" = paste("Bearer", Sys.getenv("AQUAWATCH_API_TOKEN"))
)
resp <- curl::curl_fetch_memory(url, handle = h)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
sites <- AW_Sites()
##function to get sites for token
AW_Get <- function(path, query = NULL, handle = h) {
h=handle
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(
paste(names(query), query, sep = "="),
collapse = "&"
)
url <- paste0(url, "?", qs)
}
h <- curl::new_handle()
curl::handle_setheaders(
h,
"Authorization" = paste("Bearer", Sys.getenv("AQUAWATCH_API_TOKEN"))
)
resp <- curl::curl_fetch_memory(url, handle = h)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
#Wrapper
AW_Sites <- function(handle = h) {
h=handle
AW_Get("sites",handle = h)
}
sites <- AW_Sites(handle = h)
debug(AW_Get)
AW_Get("sites",handle = h)
##function to get sites for token
AW_Get <- function(path, query = NULL, handle = h) {
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(
paste(names(query), query, sep = "="),
collapse = "&"
)
url <- paste0(url, "?", qs)
}
#h <- curl::new_handle()
curl::handle_setheaders(
handle,
"Authorization" = paste("Bearer", Sys.getenv("AQUAWATCH_API_TOKEN"))
)
resp <- curl::curl_fetch_memory(url, handle = h)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
debug(AW_Get)
AW_Get("sites",handle = h)
##function to get sites for token
AW_Get <- function(path, query = NULL, handle = h) {
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(
paste(names(query), query, sep = "="),
collapse = "&"
)
url <- paste0(url, "?", qs)
}
#h <- curl::new_handle()
curl::handle_setheaders(
handle,
"Authorization" = paste("Bearer", Sys.getenv("AQUAWATCH_API_TOKEN"))
)
resp <- curl::curl_fetch_memory(url, handle = handle)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
debug(AW_Get)
AW_Get("sites",handle = h)
Handle_Generator <- function(token) {
if (missing(token) || !nzchar(token)) stop("token is required")
h <- curl::new_handle()
curl::handle_setheaders(
h,
"Authorization" = paste("Bearer", token)
)
h
Sys.setenv(AQUAWATCH_API_TOKEN = token)
}
h <- Handle_Generator(token = "CE7Otvb9XShYRfe7xoxT")
Sys.getenv("AQUAWATCH_API_TOKEN")
Check_Credentials(Handle = h)
h <- Handle_Generator(token = "CE7Otvb9XShYRfe7xoxT")
##function to get sites for token
AW_Get <- function(path, query = NULL, handle) {
if (missing(handle)) stop("handle is required")
url <- paste0(
"https://us-central1-riverwatch-be1e4.cloudfunctions.net/api/alpha/",
path
)
if (!is.null(query)) {
qs <- paste(paste(names(query), query, sep = "="), collapse = "&")
url <- paste0(url, "?", qs)
}
resp <- curl::curl_fetch_memory(url, handle = handle)
if (resp$status_code != 200) {
stop("HTTP ", resp$status_code, ": ", rawToChar(resp$content))
}
jsonlite::fromJSON(rawToChar(resp$content), simplifyVector = TRUE)
}
Handle_Generator <- function(token) {
if (!nzchar(token)) stop("token is required")
h <- curl::new_handle()
curl::handle_setheaders(
h,
"Authorization" = paste("Bearer", token)
)
h
}
h <- Handle_Generator(token = "CE7Otvb9XShYRfe7xoxT")
Check_Credentials(Handle = h)
AW_Get("sites",handle = h)
sites <- AW_Sites(handle = h)
View(sites)
data <- AW_Samples(sites$eui[1], time_min = as.Date("2025-11-01"), time_max = as.Date("2026-01-08"))
AW_Samples <- function(
device_id,
handle,
limit = NULL,
time_min = NULL,   # POSIXct, Date, or ISO string
time_max = NULL,   # POSIXct, Date, or ISO string
order = "desc",
timezone = "etc/GMT-12"
) {
if (missing(handle) || is.null(handle)) stop("handle is required")
as_iso <- function(x) {
if (is.null(x)) return(NULL)
if (inherits(x, "POSIXt")) return(format(as.POSIXct(x, tz = timezone), "%Y-%m-%dT%H:%M:%S"))
if (inherits(x, "Date"))   return(format(x, "%Y-%m-%d"))
as.character(x)  # assume already ISO string
}
q <- list(
limit  = limit,
after  = as_iso(time_min),
before = as_iso(time_max),
order  = order
)
q <- q[!vapply(q, is.null, logical(1))]
AW_Get(paste0(device_id, "/samples"), query = q, handle = handle)
}
data <- AW_Samples(sites$eui[1], time_min = as.Date("2025-11-01"), time_max = as.Date("2026-01-08"),handle = h)
View(data)
data %>%
mutate(DateTime = ymd_hms(sampleTime, tz = "etc/GMT-12")) %>%
ggplot()+
geom_path(aes(x=DateTime,y=dissolvedOxygen))+
theme_bw()
library(tidyverse)
data %>%
mutate(DateTime = ymd_hms(sampleTime, tz = "etc/GMT-12")) %>%
ggplot()+
geom_path(aes(x=DateTime,y=dissolvedOxygen))+
theme_bw()
data <- AW_Samples(sites$eui[3], time_min = as.Date("2025-11-01"), time_max = as.Date("2026-01-08"),handle = h)
install.packages(c("devtools","usethis","roxygen2"))
create_package("path/to/AquaWatch")
library(usethis)
create_package("path/to/AquaWatch")
create_package("C:/Users/JamesDare/OneDrive - AquaWatch Solutions/Documents/R/AquaWatch")
